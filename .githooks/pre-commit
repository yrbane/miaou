#!/bin/bash
# Pre-commit hook pour Miaou
# VÃ©rifie le formatage et la qualitÃ© du code avant chaque commit

set -e

echo "ğŸ” VÃ©rification pre-commit en cours..."

# VÃ©rifier que cargo est disponible
if ! command -v cargo &> /dev/null; then
    echo "âŒ Cargo non trouvÃ©. Veuillez installer Rust."
    exit 1
fi

# Formatage automatique du code
echo "ğŸ“ Formatage du code avec rustfmt..."
if ! cargo fmt --all; then
    echo "âŒ Ã‰chec du formatage automatique"
    exit 1
fi

# VÃ©rifier le formatage
echo "âœ… VÃ©rification du formatage..."
if ! cargo fmt --all --check; then
    echo "âŒ Code mal formatÃ© dÃ©tectÃ©"
    exit 1
fi

# Linting avec clippy (sans missing_docs pour le moment)
echo "ğŸ” VÃ©rification avec clippy..."
if ! cargo clippy --all-targets --all-features -- -D warnings -A missing_docs; then
    echo "âŒ Clippy a dÃ©tectÃ© des problÃ¨mes"
    exit 1
fi

# Tests rapides (sans les benchmarks)
echo "ğŸ§ª Tests rapides..."
if ! cargo test --all --lib --bins; then
    echo "âŒ Tests Ã©chouÃ©s"
    exit 1
fi

# VÃ©rifier que les fichiers modifiÃ©s sont ajoutÃ©s
if ! git diff --cached --exit-code > /dev/null; then
    echo "âœ… Pre-commit validÃ© avec succÃ¨s !"
    echo "ğŸ“ N'oubliez pas d'ajouter les fichiers formatÃ©s si nÃ©cessaire"
else
    echo "âš ï¸  Aucun changement staged dÃ©tectÃ©"
fi

echo "ğŸ‰ Pre-commit terminÃ© avec succÃ¨s !"